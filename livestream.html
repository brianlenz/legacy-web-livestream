<html>
<head>
    <style type="text/css">
        @import url(https://fonts.googleapis.com/css?family=Titillium+Web:400,200,200italic,300,300italic,900,700italic,700,600italic,600,400italic);

        #timer, #livestream {
            font-family: 'Titillium Web', cursive;
            width: 800px;
            margin: 0 auto;
            text-align: center;
            color: rgba(26,21,26,0.7);
            font-weight: 100;
        }

        div.time {
            display: inline-block;
            line-height: 1;
            padding: 20px;
            font-size: 40px;
        }

        span.countdown-label {
            display: block;
            font-size: 20px;
            color: rgba(26,21,26,0.7);
        }

        #days {
            font-size: 100px;
            color: #db4844;
        }
        #hours {
            font-size: 100px;
            color: #f07c22;
        }
        #minutes {
            font-size: 100px;
            color: #f6da74;
        }
        #seconds {
            font-size: 50px;
            color: #abcd58;
        }

        #timer, #livestream {
            display: none;
        }
    </style>
</head>
<body>
<div id="timer">
    <div>Legacy will be live again <span id="onLiveDate">on <span id="liveDate"></span></span>, in:</div>
    <div id="days" class="time"></div>
    <div id="hours" class="time"></div>
    <div id="minutes" class="time"></div>
    <div id="seconds" class="time"></div>
</div>
<div id="livestream">
    <div>Now streaming live:</div>
    <div id="livestreamPlayer"></div>
</div>
<script
        src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
        crossorigin="anonymous"></script>
<script
        src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"
        crossorigin="anonymous"></script>
<script type="text/javascript">
    // bl: in Luxon, Sunday is 7 (vs. 0 for JS Date)
    const liveDay = 7;
    const liveHour = 11;
    const liveWindowHours = 1;
    const liveWindowMinutes = 30;
    function formatCountdownElement(amount, label, showLeadingZero) {
        return (showLeadingZero && amount < 10 ? "0" + amount : amount) + "<span class='countdown-label'>" + label + "</span>";
    }
    function legacyTime() {
        return luxon.DateTime.now().setZone('America/Denver').set({millisecond: 0});
    }
    async function isYouTubeLive() {
        try {
            // bl: there is actually a limit on the search API usage. we may hit it, so gracefully fall back if it happens.
            const response = await fetch('https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=UCDJ5xNBQ0fGnKJI5YgxAjLg&type=video&eventType=live&key=AIzaSyAxnVaGs_dBDBGDSs2GCt-K7f9fD2vc92Q');
            const json = await response.json();
            // bl: we'll show YouTube if we can't interact in the API for some reason (no JSON, no items).
            // but if we successfully get no items, then we won't show the YouTube video yet.
            return !json || !json.items || json.items.length > 0;
        } catch(e) {
            // bl: if there is an error, let's assume YouTube is live.
            return true;
        }
    }
    const timer = $('#timer');
    const livestream = $('#livestream');
    const livestreamPlayer = $('#livestreamPlayer');
    async function makeTimer() {
        let now = legacyTime();
        const isLive = now.weekday === liveDay && now.hour >= liveHour && now.hour <= (liveHour + liveWindowHours) && (now.hour < (liveHour + liveWindowHours) || now.minute < liveWindowMinutes);

        if (isLive) {
            const isStreaming = await isYouTubeLive();
            clearInterval(intervalId);
            if (isStreaming) {
                timer.hide();
                livestream.show();
                if (livestreamPlayer.is(':empty')) {
                    livestreamPlayer.html('<iframe width="560" height="315" src="https://www.youtube.com/embed/live_stream?channel=UCDJ5xNBQ0fGnKJI5YgxAjLg" frameborder="0" allowfullscreen=""></iframe>');
                }
            }
            // bl: if it's not streaming yet, then try again in 10 seconds.
            setTimeout(function() { makeTimer(); }, 10000);
            return;
        }

        livestream.hide();
        if (!livestreamPlayer.is(':empty')) {
            livestreamPlayer.html('');
        }

        let endTime = legacyTime();
        if (isLive) {
            endTime = now;
            $('#onLiveDate').hide();
        } else {
            // get the next start date
            var isSundayPreStream = now.weekday === liveDay && now.hour < liveHour;
            if (!isSundayPreStream) {
                endTime = endTime.plus({day: now.weekday === 7 ? 7 : 7 - now.weekday});
            }
            endTime = endTime.set({hour: liveHour, minute: 0, second: 0, millisecond: 0});
            $('#liveDate').html(endTime.toLocaleString(luxon.DateTime.DATETIME_FULL));
        }

        var secondsLeft = endTime.toUnixInteger() - now.toUnixInteger();

        var days = Math.floor(secondsLeft / 86400);
        var hours = Math.floor((secondsLeft - (days * 86400)) / 3600);
        var minutes = Math.floor((secondsLeft - (days * 86400) - (hours * 3600 )) / 60);
        var seconds = Math.floor((secondsLeft - (days * 86400) - (hours * 3600) - (minutes * 60)));

        $("#days").html(formatCountdownElement(days, "Days", false));
        $("#hours").html(formatCountdownElement(hours, "Hours", true));
        $("#minutes").html(formatCountdownElement(minutes, "Minutes", true));
        $("#seconds").html(formatCountdownElement(seconds, "Seconds", true));
        timer.show();
    }

    const intervalId = setInterval(function() { makeTimer(); }, 1000);
</script>
</body>
</html>
